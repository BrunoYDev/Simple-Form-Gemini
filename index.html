<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Checklist de Atendimento</title>
    <!-- Link para o Manifesto do PWA -->
    <link rel="manifest" href="manifest.json">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Biblioteca para Geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Modal de Assinatura em Tela Cheia */
        #signature-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0,0,0,0.95);
            z-index: 100;
            align-items: center;
            justify-content: center;
            display: none; /* Controlado via JS */
        }
        #signature-modal-content {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            width: 95vw;
            height: 95vh;
            display: flex;
            flex-direction: column;
            position: relative; /* Para posicionar os botões */
        }
        .canvas-wrapper {
            flex-grow: 1; 
            position: relative;
        }
        #signature-modal canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        /* Orientações para o modo paisagem/retrato no modal */
        #portrait-message { display: none; }
        #landscape-content { display: none; }

        @media (orientation: portrait) {
            #portrait-message { display: flex; }
            #landscape-content { display: none; }
        }
        @media (orientation: landscape) {
            #portrait-message { display: none; }
            #landscape-content { display: flex; }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="w-full max-w-2xl mx-auto bg-white shadow-lg rounded-b-xl">
        <div class="p-6 md:p-8" id="main-form-content">
            <div class="text-center mb-8">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Checklist de Atendimento</h1>
                <p class="text-gray-500 mt-2">Preencha todos os campos do checklist.</p>
            </div>

            <form id="checklist-form" class="space-y-6">
                <!-- Campos do formulário -->
                <div class="space-y-6">
                    <div><label for="assistencia" class="block text-sm font-medium text-gray-700 mb-1">Assistência nº</label><input type="text" id="assistencia" name="assistencia" class="w-full px-4 py-3 border border-gray-300 rounded-lg"></div>
                    <div><label for="seguradora" class="block text-sm font-medium text-gray-700 mb-1">Seguradora</label><input type="text" id="seguradora" name="seguradora" class="w-full px-4 py-3 border border-gray-300 rounded-lg"></div>
                    <div><label for="prestador" class="block text-sm font-medium text-gray-700 mb-1">Nome do Prestador</label><input type="text" id="prestador" name="prestador" required class="w-full px-4 py-3 border border-gray-300 rounded-lg"></div>
                    <div><label for="segurado" class="block text-sm font-medium text-gray-700 mb-1">Nome do Segurado</label><input type="text" id="segurado" name="segurado" required class="w-full px-4 py-3 border border-gray-300 rounded-lg"></div>
                    <div><label for="telefone" class="block text-sm font-medium text-gray-700 mb-1">Telefone do Segurado (Opcional)</label><input type="tel" id="telefone" name="telefone" placeholder="(XX) XXXXX-XXXX" class="w-full px-4 py-3 border border-gray-300 rounded-lg" maxlength="15" inputmode="tel"></div>
                    <div><label for="endereco" class="block text-sm font-medium text-gray-700 mb-1">Endereço</label><input type="text" id="endereco" name="endereco" required class="w-full px-4 py-3 border border-gray-300 rounded-lg"></div>
                    <div><label for="bairro" class="block text-sm font-medium text-gray-700 mb-1">Bairro</label><input type="text" id="bairro" name="bairro" required class="w-full px-4 py-3 border border-gray-300 rounded-lg"></div>
                    <div><label for="cidade" class="block text-sm font-medium text-gray-700 mb-1">Cidade</label><input type="text" id="cidade" name="cidade" required class="w-full px-4 py-3 border border-gray-300 rounded-lg"></div>
                    <div><label for="data_chegada" class="block text-sm font-medium text-gray-700 mb-1">Data e hora de chegada</label><input type="datetime-local" id="data_chegada" name="data_chegada" required class="w-full px-4 py-3 border border-gray-300 rounded-lg"></div>
                    <div><label for="servico_solicitado" class="block text-sm font-medium text-gray-700 mb-1">Serviço Solicitado</label><input type="text" id="servico_solicitado" name="servico_solicitado" class="w-full px-4 py-3 border border-gray-300 rounded-lg"></div>
                </div>
                <!-- Textareas -->
                <div class="space-y-4 pt-4">
                    <div><label for="motivo_solicitacao" class="block text-sm font-medium text-gray-700 mb-1">Motivo da solicitação</label><textarea id="motivo_solicitacao" name="motivo_solicitacao" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea></div>
                    <div><label for="problema_constatado" class="block text-sm font-medium text-gray-700 mb-1">Descrição do problema constatado</label><textarea id="problema_constatado" name="problema_constatado" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea></div>
                    <div><label for="avarias_preexistentes" class="block text-sm font-medium text-gray-700 mb-1">Avarias pré-existentes</label><textarea id="avarias_preexistentes" name="avarias_preexistentes" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea></div>
                    <div><label for="servico_realizado" class="block text-sm font-medium text-gray-700 mb-1">Serviço realizado</label><textarea id="servico_realizado" name="servico_realizado" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea></div>
                    <div><label for="observacoes" class="block text-sm font-medium text-gray-700 mb-1">Observações</label><textarea id="observacoes" name="observacoes" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea></div>
                </div>

                <!-- Seção de Upload de Imagens -->
                <div class="pt-6 border-t">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">Imagens da Assistência (Opcional)</h2>
                    <p class="text-sm text-gray-600 mb-4">Adicione até 10 imagens da galeria ou câmera.</p>
                    <input type="file" id="image-upload" accept="image/*" multiple class="hidden">
                    <label for="image-upload" class="w-full cursor-pointer bg-gray-100 text-gray-700 font-medium py-3 px-4 rounded-lg hover:bg-gray-200 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        Selecionar Imagens
                    </label>
                    <div id="image-preview-container" class="mt-4 grid grid-cols-3 sm:grid-cols-5 gap-4"></div>
                </div>

                <!-- Assinatura Segurado -->
                <div class="pt-6 border-t">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">Autorização e Conformidade do Segurado</h2>
                    <p class="text-sm text-gray-600 mb-4">
                        <strong>Autorização prévia:</strong> Declaro ter aceito as informações acima descritas, autorizando previamente o prestador de serviços a executar reparos necessários, sob as condições expostas.
                        <br><br>
                        <strong>Excedentes:</strong> Declaro ter aprovado e recebido os serviços e materiais testados na minha presença conforme informações descritas neste relatório técnico, bem como a conformidade do serviço.
                    </p>
                    <div id="signature-area-segurado" data-type="segurado" class="border-2 border-dashed rounded-lg p-4 text-center cursor-pointer hover:bg-gray-50">
                        <img id="signature-preview-segurado" class="hidden h-20 mx-auto mb-2" alt="Pré-visualização da Assinatura do Segurado">
                        <span class="text-blue-600 font-medium">Clique aqui para assinar</span>
                    </div>
                </div>

                <!-- Botão de Envio -->
                <div class="pt-6"><button type="submit" id="submit-button" class="w-full bg-blue-600 text-white font-bold py-4 rounded-lg flex items-center justify-center"><svg id="button-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span id="button-text">Gerar e Compartilhar PDF</span></button></div>
            </form>
        </div>
    </div>

    <!-- Modal de Assinatura -->
    <div id="signature-modal">
        <div id="portrait-message" class="flex-col items-center justify-center text-white text-center p-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 2v6h-6"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 12a9 9 0 0 1 15-6.7L21 8"/>
            </svg>
            <h2 class="text-2xl font-bold">Por favor, vire o seu dispositivo</h2>
            <p class="mt-2">A assinatura funciona melhor no modo paisagem.</p>
        </div>
        <div id="landscape-content" class="flex-col w-full h-full p-2">
             <div id="signature-modal-content">
                <div class="absolute top-2 right-2 z-20 flex space-x-2">
                    <button id="clear-signature-button" class="px-4 py-2 bg-gray-300 rounded-lg shadow-lg">Limpar</button>
                    <button id="confirm-signature-button" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-lg">Confirmar Assinatura</button>
                </div>
                <div class="canvas-wrapper">
                    <canvas id="signature-canvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const { jsPDF } = window.jspdf;
        const form = document.getElementById('checklist-form');
        const submitButton = document.getElementById('submit-button');
        const buttonSpinner = document.getElementById('button-spinner');
        const buttonText = document.getElementById('button-text');
        const phoneInput = document.getElementById('telefone');

        // Máscara para o campo Telefone
        phoneInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
            value = value.replace(/(\d{5})(\d{4})$/, '$1-$2');
            e.target.value = value.slice(0, 15);
        });

        // --- Lógica de Upload de Imagens com Otimização ---
        const imageUploadInput = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        let uploadedImages = [];
        const MAX_IMAGES = 10;

        function getOptimizedImageDataUrl(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    callback(canvas.toDataURL('image/jpeg', 0.2)); // Compressão super agressiva
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        imageUploadInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (uploadedImages.length + files.length > MAX_IMAGES) {
                alert(`Você pode selecionar no máximo ${MAX_IMAGES} imagens.`);
                e.target.value = '';
                return;
            }

            files.forEach(file => {
                getOptimizedImageDataUrl(file, (imageDataUrl) => {
                    uploadedImages.push(imageDataUrl);
                    renderImagePreviews();
                });
            });
            e.target.value = '';
        });

        function renderImagePreviews() {
            imagePreviewContainer.innerHTML = '';
            uploadedImages.forEach((imageDataUrl, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'relative';
                
                const img = document.createElement('img');
                img.src = imageDataUrl;
                img.className = 'w-full h-24 object-cover rounded-lg';
                
                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '&times;';
                removeBtn.className = 'absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold';
                removeBtn.onclick = () => {
                    uploadedImages.splice(index, 1);
                    renderImagePreviews();
                };
                
                wrapper.appendChild(img);
                wrapper.appendChild(removeBtn);
                imagePreviewContainer.appendChild(wrapper);
            });
        }

        // Modal de Assinatura
        const signatureModal = document.getElementById('signature-modal');
        const signatureCanvas = document.getElementById('signature-canvas');
        const signatureCtx = signatureCanvas.getContext('2d');
        const confirmSignatureBtn = document.getElementById('confirm-signature-button');
        const clearSignatureBtn = document.getElementById('clear-signature-button');
        
        let signatureData = { segurado: null };
        let currentSignatureType = null;
        let isDrawing = false, lastX = 0, lastY = 0;

        function resizeCanvas() {
            if (signatureCanvas.offsetWidth === 0 || signatureCanvas.offsetHeight === 0) return;
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            signatureCanvas.width = signatureCanvas.offsetWidth * ratio;
            signatureCanvas.height = signatureCanvas.offsetHeight * ratio;
            signatureCtx.scale(ratio, ratio);
            signatureCtx.lineWidth = 3;
            signatureCtx.lineCap = 'round';
            signatureCtx.strokeStyle = '#333';
            
            const existingData = signatureModal.dataset.currentData;
            if (existingData) {
                const img = new Image();
                img.src = existingData;
                img.onload = () => signatureCtx.drawImage(img, 0, 0, signatureCanvas.width / ratio, signatureCanvas.height / ratio);
            }
        }

        function getPos(e) {
            const rect = signatureCanvas.getBoundingClientRect();
            const event = e.touches ? e.touches[0] : e;
            return { x: event.clientX - rect.left, y: event.clientY - rect.top };
        }

        function startDrawing(e) { isDrawing = true; [lastX, lastY] = [getPos(e).x, getPos(e).y]; }
        function draw(e) {
            if (!isDrawing) return;
            const { x, y } = getPos(e);
            signatureCtx.beginPath();
            signatureCtx.moveTo(lastX, lastY);
            signatureCtx.lineTo(x, y);
            signatureCtx.stroke();
            [lastX, lastY] = [x, y];
        }
        function stopDrawing() { isDrawing = false; }
        function clearCanvas() { 
            signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            signatureModal.dataset.currentData = '';
        }

        ['mousedown', 'touchstart'].forEach(evt => signatureCanvas.addEventListener(evt, startDrawing, { passive: false }));
        ['mousemove', 'touchmove'].forEach(evt => signatureCanvas.addEventListener(evt, draw, { passive: false }));
        ['mouseup', 'mouseleave', 'touchend'].forEach(evt => signatureCanvas.addEventListener(evt, stopDrawing));
        clearSignatureBtn.addEventListener('click', clearCanvas);

        function openSignatureModal(type) {
            currentSignatureType = type;
            signatureModal.dataset.currentData = signatureData[type] || '';
            signatureModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            setTimeout(resizeCanvas, 50);
        }

        function closeSignatureModal() {
            signatureModal.style.display = 'none';
            document.body.style.overflow = '';
        }
        
        window.addEventListener('orientationchange', () => {
            if (signatureModal.style.display === 'flex') setTimeout(resizeCanvas, 100);
        });
        window.addEventListener('resize', () => {
             if (signatureModal.style.display === 'flex') setTimeout(resizeCanvas, 100);
        });

        document.getElementById('signature-area-segurado').addEventListener('click', () => openSignatureModal('segurado'));

        confirmSignatureBtn.addEventListener('click', () => {
            if (currentSignatureType) {
                const dataUrl = signatureCanvas.toDataURL('image/png');
                signatureData[currentSignatureType] = dataUrl;
                const previewImg = document.getElementById(`signature-preview-${currentSignatureType}`);
                previewImg.src = dataUrl;
                previewImg.classList.remove('hidden');
                document.querySelector(`#signature-area-${currentSignatureType} span`).textContent = "Alterar assinatura";
            }
            closeSignatureModal();
        });

        const addWatermark = (pdf) => {
            const pageW = pdf.internal.pageSize.getWidth();
            const pageH = pdf.internal.pageSize.getHeight();
            
            const lastFont = pdf.getFont();
            const lastColor = pdf.getTextColor();

            pdf.setFontSize(60);
            pdf.setTextColor(235, 235, 235);
            pdf.setFont('helvetica', 'bold');
            
            for (let y = 0; y < pageH; y += 100) {
                for (let x = 0; x < pageW; x += 150) {
                    pdf.text('MSERVIC', x, y, { angle: -45, align: 'left' });
                }
            }
            
            pdf.setFont(lastFont.fontName, lastFont.fontStyle);
            pdf.setTextColor(lastColor);
        };

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!form.checkValidity()) {
                alert('Por favor, preencha todos os campos obrigatórios corretamente.');
                form.reportValidity();
                return;
            }
            if (!signatureData.segurado) { alert('A assinatura do segurado é obrigatória.'); return; }

            buttonSpinner.classList.remove('hidden');
            buttonText.textContent = 'Gerando...';
            submitButton.disabled = true;

            try {
                const doc = new jsPDF();
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                addWatermark(doc);
                
                let y = 20;
                const margin = 15;
                const col1X = margin;
                const col2X = 70;
                const pageW = doc.internal.pageSize.getWidth();

                // Título Principal
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.text("Checklist de Atendimento", pageW / 2, y, { align: 'center' });
                y += 10;

                // Subtítulo com o Número da Assistência
                if (data.assistencia) {
                    doc.setFontSize(18); // Aumentado
                    doc.setFont('helvetica', 'bold'); // Negrito
                    doc.setTextColor(0, 0, 0); // Preto
                    doc.text(`Assistência nº: ${data.assistencia}`, pageW / 2, y, { align: 'center' });
                    y += 10;
                }

                doc.setLineWidth(0.5);
                doc.line(margin, y, pageW - margin, y);
                y += 10;
                doc.setTextColor(0, 0, 0); // Reseta a cor do texto

                const addLine = (label, value) => {
                    if (!value) return; 
                    if (y > 270) { 
                        doc.addPage(); 
                        addWatermark(doc);
                        y = 20; 
                    }
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${label}:`, col1X, y);
                    doc.setFont('helvetica', 'normal');
                    const textLines = doc.splitTextToSize(value, pageW - col2X - margin);
                    doc.text(textLines, col2X, y);
                    y += (textLines.length * 5) + 4;
                };

                // Adiciona os campos, exceto o de assistência que já foi usado no subtítulo
                addLine("Seguradora", data.seguradora);
                addLine("Nome do Prestador", data.prestador);
                addLine("Nome do Segurado", data.segurado);
                addLine("Telefone do Segurado", data.telefone);
                addLine("Endereço", `${data.endereco}, ${data.bairro}, ${data.cidade}`);
                addLine("Data e Hora", new Date(data.data_chegada).toLocaleString('pt-BR'));
                addLine("Serviço Solicitado", data.servico_solicitado);

                y += 5; doc.line(margin, y, pageW - margin, y); y += 10;
                addLine("Motivo da Solicitação", data.motivo_solicitacao);
                addLine("Problema Constatado", data.problema_constatado);
                addLine("Avarias Pré-existentes", data.avarias_preexistentes);
                addLine("Serviço Realizado", data.servico_realizado);
                addLine("Observações", data.observacoes);

                const addSignatureSection = (title, text, signatureImg) => {
                    if (y > 200) { 
                        doc.addPage(); 
                        addWatermark(doc);
                        y = 20; 
                    }
                    y += 10;
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text(title, margin, y);
                    y += 6;
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'italic');
                    const textLines = doc.splitTextToSize(text, pageW - (margin * 2));
                    doc.text(textLines, margin, y);
                    y += (textLines.length * 3) + 10;

                    const signatureWidth = pageW - (margin * 4);
                    const signatureHeight = signatureWidth / 2.5;
                    const signatureX = (pageW - signatureWidth) / 2;

                    doc.setLineDashPattern([1, 1], 0);
                    doc.rect(signatureX, y, signatureWidth, signatureHeight);
                    doc.setLineDashPattern([], 0);

                    doc.addImage(signatureImg, 'PNG', signatureX, y, signatureWidth, signatureHeight);
                    y += signatureHeight + 10;
                };

                const combinedText = "Declaro ter aceito as informações acima descritas, autorizando previamente o prestador de serviços a executar reparos necessários, sob as condições expostas. Declaro também ter aprovado e recebido os serviços e materiais testados na minha presença conforme informações descritas neste relatório técnico, bem como a conformidade do serviço."
                addSignatureSection("Assinatura do Segurado (Autorização e Conformidade)", combinedText, signatureData.segurado);

                if (uploadedImages.length > 0) {
                    doc.addPage();
                    addWatermark(doc);
                    let imgY = 20;
                    const imgMargin = 15;
                    
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text("Imagens da Assistência", pageW / 2, imgY, { align: 'center' });
                    imgY += 15;

                    const contentWidth = pageW - (imgMargin * 2);
                    const maxImgHeight = 120;
                    const gap = 5;

                    for (const imgDataUrl of uploadedImages) {
                        const img = new Image();
                        img.src = imgDataUrl;
                        await new Promise(resolve => img.onload = resolve);
                        
                        const aspectRatio = img.width / img.height;
                        let imgWidth = img.width;
                        let imgHeight = img.height;

                        if (imgWidth > contentWidth) {
                            imgWidth = contentWidth;
                            imgHeight = imgWidth / aspectRatio;
                        }
                        if (imgHeight > maxImgHeight) {
                            imgHeight = maxImgHeight;
                            imgWidth = imgHeight * aspectRatio;
                        }
                        
                        if (imgY + imgHeight > doc.internal.pageSize.getHeight() - imgMargin) {
                            doc.addPage();
                            addWatermark(doc);
                            imgY = 20;
                        }

                        const centeredX = (pageW - imgWidth) / 2;
                        doc.addImage(imgDataUrl, 'JPEG', centeredX, imgY, imgWidth, imgHeight);
                        imgY += imgHeight + gap;
                    }
                }

                const assistanceNumber = (data.assistencia || 'SN').replace(/\//g, '-');
                const pdfFileName = `checklist-${assistanceNumber}.pdf`;
                const pdfFile = new File([doc.output('blob')], pdfFileName, { type: 'application/pdf' });

                if (navigator.share) {
                    try {
                        await navigator.share({ title: pdfFileName, files: [pdfFile] });
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            console.error('Share API failed:', error);
                            alert('Não foi possível compartilhar. O download será iniciado.');
                            doc.save(pdfFileName);
                        }
                    }
                } else {
                    doc.save(pdfFileName);
                }

            } catch (error) {
                console.error("Erro ao gerar PDF:", error);
                alert("Ocorreu um erro ao gerar o PDF. Tente novamente.");
            } finally {
                buttonSpinner.classList.add('hidden');
                buttonText.textContent = 'Gerar e Compartilhar PDF';
                submitButton.disabled = false;
            }
        });
    });

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
        .then(registration => {
            console.log('Service Worker registrado com sucesso:', registration);
        })
        .catch(error => {
            console.log('Falha ao registrar o Service Worker:', error);
        });
        });
    }
    </script>
</body>
</html>