<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist de Atendimento</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Biblioteca para Geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .signature-canvas {
            touch-action: none;
        }
        /* Melhora a aparência do input de data/hora */
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            background-color: #f3f4f6;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="w-full max-w-2xl mx-auto bg-white shadow-lg rounded-b-xl">
        
        <div class="p-6 md:p-8">
            <div class="text-center mb-8">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Checklist de Atendimento</h1>
                <p class="text-gray-500 mt-2">Preencha todos os campos do checklist.</p>
            </div>

            <form id="checklist-form" class="space-y-6">
                <!-- Campos do formulário em coluna única para melhor visualização no celular -->
                <div>
                    <label for="assistencia" class="block text-sm font-medium text-gray-700 mb-1">Assistência nº</label>
                    <input type="text" id="assistencia" name="assistencia" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="seguradora" class="block text-sm font-medium text-gray-700 mb-1">Seguradora</label>
                    <input type="text" id="seguradora" name="seguradora" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="segurado" class="block text-sm font-medium text-gray-700 mb-1">Segurado</label>
                    <input type="text" id="segurado" name="segurado" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="endereco" class="block text-sm font-medium text-gray-700 mb-1">Endereço</label>
                    <input type="text" id="endereco" name="endereco" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="bairro" class="block text-sm font-medium text-gray-700 mb-1">Bairro</label>
                    <input type="text" id="bairro" name="bairro" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="cidade" class="block text-sm font-medium text-gray-700 mb-1">Cidade</label>
                    <input type="text" id="cidade" name="cidade" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="referencia" class="block text-sm font-medium text-gray-700 mb-1">Referência</label>
                    <input type="text" id="referencia" name="referencia" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="data_chegada" class="block text-sm font-medium text-gray-700 mb-1">Data e hora de chegada</label>
                    <input type="datetime-local" id="data_chegada" name="data_chegada" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="servico_solicitado" class="block text-sm font-medium text-gray-700 mb-1">Serviço Solicitado</label>
                    <input type="text" id="servico_solicitado" name="servico_solicitado" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <!-- Campos de Texto Grandes -->
                <div class="space-y-4">
                    <div>
                        <label for="motivo_solicitacao" class="block text-sm font-medium text-gray-700 mb-1">Motivo da solicitação</label>
                        <textarea id="motivo_solicitacao" name="motivo_solicitacao" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div>
                        <label for="problema_constatado" class="block text-sm font-medium text-gray-700 mb-1">Descrição do problema constatado</label>
                        <textarea id="problema_constatado" name="problema_constatado" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div>
                        <label for="avarias_preexistentes" class="block text-sm font-medium text-gray-700 mb-1">Avarias pré-existentes</label>
                        <textarea id="avarias_preexistentes" name="avarias_preexistentes" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div>
                        <label for="servico_realizado" class="block text-sm font-medium text-gray-700 mb-1">Serviço realizado</label>
                        <textarea id="servico_realizado" name="servico_realizado" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div>
                        <label for="observacoes" class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                        <textarea id="observacoes" name="observacoes" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                </div>

                <!-- Seção de Assinatura do Segurado -->
                <div class="pt-6 border-t">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">Autorização e Conformidade</h2>
                    <p class="text-sm text-gray-600 mb-4">
                        <strong>Autorização prévia:</strong> Declaro ter aceito as informações acima descritas, autorizando previamente o prestador de serviços a executar reparos necessários, sob as condições expostas.
                    </p>
                    <div>
                        <label for="rg" class="block text-sm font-medium text-gray-700 mb-1">R.G:</label>
                        <input type="text" id="rg" name="rg" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mb-4">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Assinatura do segurado</label>
                        <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-1">
                            <canvas id="signature-pad-segurado" class="w-full h-40 rounded-md signature-canvas bg-white"></canvas>
                        </div>
                        <div class="flex justify-end mt-2">
                            <button type="button" id="clear-button-segurado" class="text-sm text-blue-600 hover:text-blue-800 font-medium">Limpar</button>
                        </div>
                    </div>
                </div>

                <!-- Seção de Assinatura do Prestador -->
                <div class="pt-6 border-t">
                    <p class="text-sm text-gray-600 mb-4">
                        <strong>Excedentes:</strong> Declaro ter aprovado e recebido os serviços e materiais testados na minha presença conforme informações descritas neste relatório técnico, bem como a conformidade do serviço.
                    </p>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Assinatura do prestador</label>
                        <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-1">
                            <canvas id="signature-pad-prestador" class="w-full h-40 rounded-md signature-canvas bg-white"></canvas>
                        </div>
                        <div class="flex justify-end mt-2">
                            <button type="button" id="clear-button-prestador" class="text-sm text-blue-600 hover:text-blue-800 font-medium">Limpar</button>
                        </div>
                    </div>
                </div>

                <!-- Botão de Envio Fixo no final da tela -->
                <div class="pt-6">
                    <button type="submit" id="submit-button" class="w-full bg-blue-600 text-white font-bold py-4 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out flex items-center justify-center">
                        <svg id="button-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span id="button-text">Gerar e Compartilhar PDF</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;
            const form = document.getElementById('checklist-form');
            const submitButton = document.getElementById('submit-button');
            const buttonSpinner = document.getElementById('button-spinner');
            const buttonText = document.getElementById('button-text');

            function createSignaturePad(canvasId, clearButtonId) {
                const canvas = document.getElementById(canvasId);
                const clearButton = document.getElementById(clearButtonId);
                const ctx = canvas.getContext('2d');
                let isDrawing = false;
                let lastX = 0;
                let lastY = 0;

                function resizeCanvas() {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    ctx.scale(ratio, ratio);
                    ctx.lineWidth = 2.5; // Linha um pouco mais grossa para toque
                    ctx.lineCap = 'round';
                    ctx.strokeStyle = '#333';
                }

                window.addEventListener('resize', resizeCanvas);
                resizeCanvas();

                function getPos(e) {
                    const rect = canvas.getBoundingClientRect();
                    const event = e.touches ? e.touches[0] : e;
                    return { x: event.clientX - rect.left, y: event.clientY - rect.top };
                }

                function startDrawing(e) {
                    e.preventDefault();
                    isDrawing = true;
                    const pos = getPos(e);
                    [lastX, lastY] = [pos.x, pos.y];
                }

                function draw(e) {
                    if (!isDrawing) return;
                    e.preventDefault();
                    const pos = getPos(e);
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(pos.x, pos.y);
                    ctx.stroke();
                    [lastX, lastY] = [pos.x, pos.y];
                }

                function stopDrawing() { isDrawing = false; }
                function clear() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseleave', stopDrawing);
                canvas.addEventListener('touchstart', startDrawing, { passive: false });
                canvas.addEventListener('touchmove', draw, { passive: false });
                canvas.addEventListener('touchend', stopDrawing);
                clearButton.addEventListener('click', clear);

                return {
                    getDataURL: () => canvas.toDataURL('image/png'),
                    isBlank: () => !ctx.getImageData(0, 0, canvas.width, canvas.height).data.some(channel => channel !== 0)
                };
            }

            const signaturePadSegurado = createSignaturePad('signature-pad-segurado', 'clear-button-segurado');
            const signaturePadPrestador = createSignaturePad('signature-pad-prestador', 'clear-button-prestador');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (signaturePadSegurado.isBlank()) {
                    alert('Por favor, o segurado precisa assinar.');
                    return;
                }
                if (signaturePadPrestador.isBlank()) {
                    alert('Por favor, o prestador precisa assinar.');
                    return;
                }

                buttonSpinner.classList.remove('hidden');
                buttonText.textContent = 'Gerando...';
                submitButton.disabled = true;

                try {
                    // 1. Gerar o PDF
                    const doc = new jsPDF();
                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData.entries());
                    
                    let y = 15;
                    const margin = 10;
                    const maxWidth = doc.internal.pageSize.getWidth() - margin * 2;

                    const addText = (label, value, isBold = false) => {
                        if (y > 280) { doc.addPage(); y = 15; }
                        doc.setFont('helvetica', isBold ? 'bold' : 'normal');
                        const labelWidth = doc.getTextWidth(label + ':') + 2;
                        doc.text(`${label}:`, margin, y);
                        doc.setFont('helvetica', 'normal');
                        const textLines = doc.splitTextToSize(value || '-', maxWidth - labelWidth);
                        doc.text(textLines, margin + labelWidth, y);
                        y += (textLines.length * 5) + 5;
                    };
                    
                    doc.setFontSize(16);
                    doc.text("Checklist de Atendimento", doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
                    y += 10;
                    doc.setFontSize(11);

                    addText("Assistência nº", data.assistencia);
                    addText("Seguradora", data.seguradora);
                    addText("Segurado", data.segurado, true);
                    addText("Endereço", `${data.endereco}, ${data.bairro}, ${data.cidade}`);
                    addText("Referência", data.referencia);
                    addText("Data e Hora", new Date(data.data_chegada).toLocaleString('pt-BR'));
                    y += 5; doc.line(margin, y, maxWidth + margin, y); y += 5;
                    
                    addText("Motivo", data.motivo_solicitacao);
                    addText("Problema", data.problema_constatado);
                    addText("Avarias", data.avarias_preexistentes);
                    addText("Serviço", data.servico_realizado);
                    addText("Obs", data.observacoes);
                    
                    const addSignature = (label, signaturePad, rgValue) => {
                        if (y > 220) { doc.addPage(); y = 15; }
                        y += 10;
                        doc.setFont('helvetica', 'bold');
                        doc.text(label, margin, y);
                        const signatureImg = signaturePad.getDataURL();
                        doc.addImage(signatureImg, 'PNG', margin, y + 5, 70, 35);
                        if (rgValue) {
                            doc.setFont('helvetica', 'normal');
                            doc.text(`R.G: ${rgValue}`, margin + 80, y + 25);
                        }
                        y += 50;
                    };

                    addSignature("Assinatura do Segurado", signaturePadSegurado, data.rg);
                    addSignature("Assinatura do Prestador", signaturePadPrestador);

                    // 2. Converter PDF para Blob e depois para File
                    const pdfBlob = doc.output('blob');
                    const pdfFile = new File([pdfBlob], `checklist-${data.segurado.replace(/\s/g, '_')}.pdf`, {
                        type: 'application/pdf'
                    });

                    // 3. Tentar compartilhar (mobile) ou fazer download (desktop)
                    if (navigator.share && navigator.canShare({ files: [pdfFile] })) {
                        // API de compartilhamento (Mobile)
                        await navigator.share({
                            title: 'Checklist de Atendimento',
                            text: `Checklist para o segurado ${data.segurado}`,
                            files: [pdfFile]
                        });
                    } else {
                        // Fallback para Download (Desktop)
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(pdfFile);
                        link.download = pdfFile.name;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(link.href);
                    }

                } catch (error) {
                    // Ignora o erro se o usuário cancelar o compartilhamento
                    if (error.name !== 'AbortError') {
                        console.error("Erro ao gerar ou compartilhar o PDF:", error);
                        alert("Ocorreu um erro. Tente novamente.");
                    }
                } finally {
                    buttonSpinner.classList.add('hidden');
                    buttonText.textContent = 'Gerar e Compartilhar PDF';
                    submitButton.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
